<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Rate Observer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Currency Rate Observer</h1>
            <div class="connection-status">
                <span id="status-indicator" class="status-disconnected"></span>
                <span id="status-text">Connecting...</span>
            </div>
        </header>

        <div class="client-info">
            <div class="info-card">
                <h3>Client Information</h3>
                <p><strong>Client ID:</strong> <span id="client-id">---</span></p>
                <p><strong>Connected:</strong> <span id="connected-time">---</span></p>
                <p><strong>Messages:</strong> <span id="message-count">0</span></p>
                <p><strong>Server:</strong> {{ host }}:{{ port }}</p>
                <p><strong>Mode:</strong> 
                    {% if test_mode %}
                        Test
                    {% else %}
                        Production
                    {% end %}
                </p>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>Controls</h3>
                <button id="subscribe-all" class="btn">
                    Subscribe to All
                </button>
                <button id="subscribe-selected" class="btn">
                    Subscribe to Selected
                </button>
                <button id="get-rates" class="btn">
                    Get Current Rates
                </button>
                {% if test_mode %}
                <button id="simulate-change" class="btn">
                    Simulate Change
                </button>
                {% end %}
                <button id="clear-log" class="btn">
                    Clear Log
                </button>
            </div>

            <div class="currency-selection">
                <h3>Currency Selection</h3>
                <div class="currency-grid">
                    {% for currency in currencies %}
                    <div class="currency-checkbox">
                        <input type="checkbox" id="currency-{{ currency }}" 
                               value="{{ currency }}" checked>
                        <label for="currency-{{ currency }}">{{ currency }}</label>
                    </div>
                    {% end %}
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="rates-panel">
                <h3>Current Exchange Rates</h3>
                <div class="rates-table-container">
                    <table class="rates-table">
                        <thead>
                            <tr>
                                <th>Currency</th>
                                <th>Code</th>
                                <th>Rate (RUB)</th>
                                <th>Change</th>
                            </tr>
                        </thead>
                        <tbody id="rates-body">
                            <tr>
                                <td colspan="4">Loading rates...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="log-panel">
                <h3>Live Updates</h3>
                <div class="log-controls">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="increase">Increases</button>
                        <button class="filter-btn" data-filter="decrease">Decreases</button>
                        <button class="filter-btn" data-filter="system">System</button>
                    </div>
                    <div class="log-info">
                        <span id="log-count">0 messages</span>
                    </div>
                </div>
                <div class="log-container" id="log-container">
                    <div class="log-entry system">
                        <div class="log-time">--:--:--</div>
                        <div class="log-content">
                            <span>Waiting for updates...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>Currency Rate Observer | Data source: CBR API | Pattern: Observer</p>
        </footer>
    </div>

    <script>
        const CONFIG = {
            host: "{{ host }}",
            port: {{ port }},
            testMode: {% if test_mode %}true{% else %}false{% end %},
            currencies: {% raw json.dumps(currencies) %}
        };

        let ws = null;
        let clientId = null;
        let connectedTime = null;
        let messageCount = 0;
        let currentRates = {};
        let logEntries = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            setupEventListeners();
        });
        
        function initWebSocket() {
            const wsUrl = `ws://${CONFIG.host}:${CONFIG.port}/ws`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                updateStatus('connected', 'Connected');
                connectedTime = new Date();
                updateConnectedTime();
                setInterval(updateConnectedTime, 1000);
                setInterval(sendPing, 30000);
            };
            
            ws.onclose = function() {
                updateStatus('disconnected', 'Disconnected');
                setTimeout(function() {
                    if (ws.readyState === WebSocket.CLOSED) {
                        updateStatus('connecting', 'Reconnecting...');
                        initWebSocket();
                    }
                }, 5000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateStatus('error', 'Connection error');
            };
            
            ws.onmessage = function(event) {
                messageCount++;
                document.getElementById('message-count').textContent = messageCount;
                
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing message:', error);
                    addLogEntry('system', 'Error: Invalid message format', true);
                }
            };
        }
        
        function handleWebSocketMessage(data) {
            const type = data.type;
            
            switch(type) {
                case 'welcome':
                    handleWelcomeMessage(data);
                    break;
                case 'rates_updated':
                    handleRatesUpdated(data);
                    break;
                case 'current_rates':
                    handleCurrentRates(data);
                    break;
                case 'subscription_updated':
                    handleSubscriptionUpdated(data);
                    break;
                case 'pong':
                    updateLastUpdateTime();
                    break;
                case 'simulation_started':
                    addLogEntry('system', `Simulation started`, true);
                    break;
                case 'error':
                    addLogEntry('system', `Error: ${data.message}`, true);
                    break;
                default:
                    console.log('Unknown message type:', type, data);
            }
        }
        
        function handleWelcomeMessage(data) {
            clientId = data.client_id;
            document.getElementById('client-id').textContent = clientId;
            
            addLogEntry('system', `Connected: ${clientId}`, true);
            
            if (data.current_rates) {
                currentRates = data.current_rates;
                updateCurrentRatesTable();
            }
            
            sendSubscription();
        }
        
        function handleRatesUpdated(data) {
            updateLastUpdateTime();
            
            if (data.all_rates) {
                for (const [code, rate] of Object.entries(data.all_rates)) {
                    if (currentRates[code]) {
                        currentRates[code].previous = currentRates[code].value;
                        currentRates[code].value = rate;
                    }
                }
            }
            
            if (data.changes && data.changes.length > 0) {
                data.changes.forEach(change => {
                    const changeType = change.type;
                    const code = change.code;
                    const name = change.name;
                    const oldRate = change.old_rate;
                    const newRate = change.new_rate;
                    
                    let message = '';
                    
                    if (changeType === 'new') {
                        message = `New: ${code} (${name}) at ${newRate.toFixed(4)}`;
                    } else if (changeType === 'increase') {
                        message = `${code} ↑ ${oldRate.toFixed(4)} → ${newRate.toFixed(4)}`;
                    } else if (changeType === 'decrease') {
                        message = `${code} ↓ ${oldRate.toFixed(4)} → ${newRate.toFixed(4)}`;
                    }
                    
                    addLogEntry(changeType, message, false);
                });
                
                updateCurrentRatesTable();
            }
        }
        
        function handleCurrentRates(data) {
            if (data.rates) {
                currentRates = data.rates;
                updateCurrentRatesTable();
                addLogEntry('system', 'Rates updated', true);
            }
        }
        
        function handleSubscriptionUpdated(data) {
            const currencies = data.currencies.join(', ');
            addLogEntry('system', `Subscribed to: ${currencies}`, true);
        }
        
        function updateCurrentRatesTable() {
            const tbody = document.getElementById('rates-body');
            
            if (Object.keys(currentRates).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4">No data</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            CONFIG.currencies.forEach(currencyCode => {
                const rateInfo = currentRates[currencyCode];
                
                if (!rateInfo) {
                    html += `
                        <tr>
                            <td>Unknown</td>
                            <td>${currencyCode}</td>
                            <td colspan="2">No data</td>
                        </tr>
                    `;
                    return;
                }
                
                const value = rateInfo.value || 0;
                const previous = rateInfo.previous || value;
                const change = value - previous;
                
                let changeClass = '';
                let changeText = '';
                
                if (change > 0.001) {
                    changeClass = 'increase';
                    changeText = `+${change.toFixed(4)}`;
                } else if (change < -0.001) {
                    changeClass = 'decrease';
                    changeText = `${change.toFixed(4)}`;
                } else {
                    changeClass = 'neutral';
                    changeText = `0.0000`;
                }
                
                html += `
                    <tr>
                        <td>${rateInfo.name}</td>
                        <td>${currencyCode}</td>
                        <td>${value.toFixed(4)}</td>
                        <td class="change ${changeClass}">${changeText}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function addLogEntry(type, message, isSystem = false) {
            const timestamp = new Date();
            const timeStr = timestamp.toLocaleTimeString();
            
            const logEntry = {
                id: Date.now() + Math.random(),
                time: timeStr,
                timestamp: timestamp,
                type: type,
                message: message,
                isSystem: isSystem
            };
            
            logEntries.unshift(logEntry);
            
            if (logEntries.length > 100) {
                logEntries.pop();
            }
            
            document.getElementById('log-count').textContent = `${logEntries.length} messages`;
            
            addLogEntryToDOM(logEntry);
        }
        
        function addLogEntryToDOM(logEntry) {
            const logContainer = document.getElementById('log-container');
            
            const logElement = document.createElement('div');
            logElement.className = `log-entry ${logEntry.type}`;
            logElement.dataset.id = logEntry.id;
            logElement.dataset.type = logEntry.type;
            
            logElement.innerHTML = `
                <div class="log-time">${logEntry.time}</div>
                <div class="log-content">${logEntry.message}</div>
            `;
            
            if (logContainer.firstChild) {
                logContainer.insertBefore(logElement, logContainer.firstChild);
            } else {
                logContainer.appendChild(logElement);
            }
            
            const waitingMsg = logContainer.querySelector('.log-entry.system:last-child');
            if (waitingMsg && waitingMsg.querySelector('.log-content').textContent === 'Waiting for updates...') {
                waitingMsg.remove();
            }
        }
        
        function sendSubscription() {
            const selectedCurrencies = getSelectedCurrencies();
            
            const message = {
                type: 'subscribe',
                currencies: selectedCurrencies
            };
            
            sendWebSocketMessage(message);
        }
        
        function getSelectedCurrencies() {
            const checkboxes = document.querySelectorAll('.currency-checkbox input:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function sendWebSocketMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
                return true;
            } else {
                addLogEntry('system', 'Cannot send: Not connected', true);
                return false;
            }
        }
        
        function sendPing() {
            sendWebSocketMessage({ type: 'ping' });
        }
        
        function updateStatus(status, text) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            indicator.className = 'status-' + status;
            statusText.textContent = text;
        }
        
        function updateConnectedTime() {
            if (connectedTime) {
                const now = new Date();
                const diffSec = Math.floor((now - connectedTime) / 1000);
                document.getElementById('connected-time').textContent = `${diffSec}s`;
            }
        }
        
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
        }
        
        function setupEventListeners() {
            document.getElementById('subscribe-all').addEventListener('click', function() {
                document.querySelectorAll('.currency-checkbox input').forEach(cb => {
                    cb.checked = true;
                });
                sendSubscription();
            });
            
            document.getElementById('subscribe-selected').addEventListener('click', function() {
                sendSubscription();
            });
            
            document.getElementById('get-rates').addEventListener('click', function() {
                sendWebSocketMessage({ type: 'get_rates' });
            });
            
            const simulateBtn = document.getElementById('simulate-change');
            if (simulateBtn) {
                simulateBtn.addEventListener('click', function() {
                    sendWebSocketMessage({ type: 'simulate_change' });
                });
            }
            
            document.getElementById('clear-log').addEventListener('click', function() {
                logEntries = [];
                document.getElementById('log-container').innerHTML = '';
                document.getElementById('log-count').textContent = '0 messages';
                addLogEntry('system', 'Log cleared', true);
            });
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    applyLogFilter(this.dataset.filter);
                });
            });
            
            document.querySelectorAll('.currency-checkbox input').forEach(cb => {
                cb.addEventListener('change', function() {
                    sendSubscription();
                });
            });
        }
        
        function applyLogFilter(filterType) {
            const logEntries = document.querySelectorAll('.log-entry');
            
            logEntries.forEach(entry => {
                const entryType = entry.dataset.type;
                
                if (filterType === 'all' || 
                    (filterType === 'system' && entryType === 'system') ||
                    (filterType === entryType && entryType !== 'system')) {
                    entry.style.display = 'flex';
                } else {
                    entry.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>