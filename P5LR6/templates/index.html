<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Rate Observer</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-chart-line"></i> Currency Rate Observer</h1>
            <div class="connection-status">
                <span id="status-indicator" class="status-offline"></span>
                <span id="status-text">Connecting...</span>
            </div>
        </header>

        <div class="client-info">
            <div class="info-card">
                <h3><i class="fas fa-id-card"></i> Client Information</h3>
                <p><strong>Client ID:</strong> <span id="client-id">---</span></p>
                <p><strong>Connected:</strong> <span id="connected-time">---</span></p>
                <p><strong>Messages received:</strong> <span id="message-count">0</span></p>
                <p><strong>Server:</strong> {{ host }}:{{ port }}</p>
                <p><strong>Mode:</strong> 
                    <span class="mode-indicator">
                        {% if test_mode %}
                            Test
                        {% else %}
                            Production
                        {% end %}
                    </span>
                </p>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3><i class="fas fa-sliders-h"></i> Controls</h3>
                <button id="subscribe-all" class="btn btn-primary">
                    <i class="fas fa-bell"></i> Subscribe to All
                </button>
                <button id="subscribe-selected" class="btn btn-secondary">
                    <i class="fas fa-bell"></i> Subscribe to Selected
                </button>
                <button id="get-rates" class="btn btn-info">
                    <i class="fas fa-sync"></i> Get Current Rates
                </button>
                {% if test_mode %}
                <button id="simulate-change" class="btn btn-warning">
                    <i class="fas fa-vial"></i> Simulate Change
                </button>
                {% end %}
                <button id="clear-log" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Clear Log
                </button>
            </div>

            <div class="currency-selection">
                <h3><i class="fas fa-coins"></i> Currency Selection</h3>
                <div class="currency-grid">
                    {% for currency in currencies %}
                    <div class="currency-checkbox">
                        <input type="checkbox" id="currency-{{ currency }}" 
                               value="{{ currency }}" checked>
                        <label for="currency-{{ currency }}">{{ currency }}</label>
                    </div>
                    {% end %}
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="rates-panel">
                <h3><i class="fas fa-exchange-alt"></i> Current Exchange Rates</h3>
                <div class="rates-table-container">
                    <table class="rates-table">
                        <thead>
                            <tr>
                                <th>Currency</th>
                                <th>Code</th>
                                <th>Rate (RUB)</th>
                                <th>Previous</th>
                                <th>Change</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="rates-body">
                            <!-- Rates will be populated by JavaScript -->
                            <tr>
                                <td colspan="6" class="loading">Loading rates...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="log-panel">
                <h3><i class="fas fa-history"></i> Live Updates</h3>
                <div class="log-controls">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="increase">Increases</button>
                        <button class="filter-btn" data-filter="decrease">Decreases</button>
                        <button class="filter-btn" data-filter="new">New</button>
                        <button class="filter-btn" data-filter="system">System</button>
                    </div>
                    <div class="log-info">
                        <span id="log-count">0 messages</span>
                    </div>
                </div>
                <div class="log-container" id="log-container">
                    <!-- Log messages will be added here -->
                    <div class="log-entry system">
                        <div class="log-time">--:--:--</div>
                        <div class="log-content">
                            <i class="fas fa-info-circle"></i>
                            <span>Waiting for updates...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>Currency Rate Observer &copy; 2023 | 
                Data source: <a href="https://www.cbr-xml-daily.ru" target="_blank">Central Bank of Russia API</a> |
                Pattern: <strong>Observer</strong> |
                <span id="last-update">Last update: --:--:--</span>
            </p>
        </footer>
    </div>

    <script>
        // Конфигурация - ИСПРАВЛЕННАЯ ВЕРСИЯ
        const CONFIG = {
            host: "{{ host }}",
            port: {{ port }},
            testMode: {% if test_mode %}true{% else %}false{% end %},
            currencies: {% raw json.dumps(currencies) %}
        };

        // Глобальные переменные
        let ws = null;
        let clientId = null;
        let connectedTime = null;
        let messageCount = 0;
        let currentRates = {};
        let logEntries = [];
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            setupEventListeners();
            updateCurrentRatesTable();
        });
        
        // Инициализация WebSocket соединения
        function initWebSocket() {
            const wsUrl = `ws://${CONFIG.host}:${CONFIG.port}/ws`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                updateStatus('connected', 'Connected to server');
                connectedTime = new Date();
                updateConnectedTime();
                
                // Запускаем периодическое обновление времени подключения
                setInterval(updateConnectedTime, 1000);
                
                // Отправляем ping каждые 30 секунд для поддержания соединения
                setInterval(sendPing, 30000);
            };
            
            ws.onclose = function() {
                updateStatus('disconnected', 'Disconnected from server');
                
                // Пытаемся переподключиться через 5 секунд
                setTimeout(function() {
                    if (ws.readyState === WebSocket.CLOSED) {
                        updateStatus('connecting', 'Reconnecting...');
                        initWebSocket();
                    }
                }, 5000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateStatus('error', 'Connection error');
            };
            
            ws.onmessage = function(event) {
                messageCount++;
                document.getElementById('message-count').textContent = messageCount;
                
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                    addLogEntry('system', `Error: Invalid message format`, true);
                }
            };
        }
        
        // Обработка сообщений от WebSocket
        function handleWebSocketMessage(data) {
            const type = data.type;
            
            switch(type) {
                case 'welcome':
                    handleWelcomeMessage(data);
                    break;
                    
                case 'rates_updated':
                    handleRatesUpdated(data);
                    break;
                    
                case 'current_rates':
                    handleCurrentRates(data);
                    break;
                    
                case 'subscription_updated':
                    handleSubscriptionUpdated(data);
                    break;
                    
                case 'pong':
                    // Просто обновляем время последней активности
                    updateLastUpdateTime();
                    break;
                    
                case 'simulation_started':
                    addLogEntry('system', `Simulation started: ${data.message}`, true);
                    break;
                    
                case 'error':
                    addLogEntry('system', `Error: ${data.message}`, true);
                    break;
                    
                default:
                    console.log('Unknown message type:', type, data);
            }
        }
        
        // Обработка приветственного сообщения
        function handleWelcomeMessage(data) {
            clientId = data.client_id;
            document.getElementById('client-id').textContent = clientId;
            
            addLogEntry('system', `Connected with ID: ${clientId}`, true);
            addLogEntry('system', data.message, true);
            
            // Загружаем начальные курсы
            if (data.current_rates) {
                currentRates = data.current_rates;
                updateCurrentRatesTable();
            }
            
            // Подписываемся на выбранные валюты
            sendSubscription();
        }
        
        // Обработка обновления курсов
        function handleRatesUpdated(data) {
            updateLastUpdateTime();
            
            // Обновляем текущие курсы
            if (data.all_rates) {
                for (const [code, rate] of Object.entries(data.all_rates)) {
                    if (currentRates[code]) {
                        currentRates[code].previous = currentRates[code].value;
                        currentRates[code].value = rate;
                    }
                }
            }
            
            // Добавляем записи в лог для каждого изменения
            if (data.changes && data.changes.length > 0) {
                data.changes.forEach(change => {
                    const changeType = change.type;
                    const code = change.code;
                    const name = change.name;
                    const oldRate = change.old_rate;
                    const newRate = change.new_rate;
                    const changePercent = change.change_percent;
                    const nominal = change.nominal || 1;
                    
                    let message = '';
                    let icon = '';
                    
                    if (changeType === 'new') {
                        message = `New currency: ${code} (${name}) added at ${newRate.toFixed(4)} RUB`;
                        icon = 'fas fa-plus-circle';
                    } else if (changeType === 'increase') {
                        message = `${code} increased: ${oldRate.toFixed(4)} → ${newRate.toFixed(4)} RUB (${changePercent.toFixed(2)}%)`;
                        icon = 'fas fa-arrow-up';
                    } else if (changeType === 'decrease') {
                        message = `${code} decreased: ${oldRate.toFixed(4)} → ${newRate.toFixed(4)} RUB (${changePercent.toFixed(2)}%)`;
                        icon = 'fas fa-arrow-down';
                    }
                    
                    if (change.simulated) {
                        message += ' [SIMULATED]';
                    }
                    
                    addLogEntry(changeType, message, false, icon);
                });
                
                // Обновляем таблицу курсов
                updateCurrentRatesTable();
            }
        }
        
        // Обработка текущих курсов
        function handleCurrentRates(data) {
            if (data.rates) {
                currentRates = data.rates;
                updateCurrentRatesTable();
                addLogEntry('system', 'Current rates updated', true);
            }
        }
        
        // Обработка обновления подписки
        function handleSubscriptionUpdated(data) {
            const currencies = data.currencies.join(', ');
            addLogEntry('system', `Subscription updated: ${currencies}`, true);
        }
        
        // Обновление таблицы текущих курсов
        function updateCurrentRatesTable() {
            const tbody = document.getElementById('rates-body');
            
            if (Object.keys(currentRates).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="loading">No rate data available</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            CONFIG.currencies.forEach(currencyCode => {
                const rateInfo = currentRates[currencyCode];
                
                if (!rateInfo) {
                    html += `
                        <tr>
                            <td>Unknown</td>
                            <td>${currencyCode}</td>
                            <td colspan="4" class="no-data">No data</td>
                        </tr>
                    `;
                    return;
                }
                
                const value = rateInfo.value || 0;
                const previous = rateInfo.previous || value;
                const change = value - previous;
                const changePercent = previous !== 0 ? (change / previous) * 100 : 0;
                
                let changeClass = '';
                let changeIcon = '';
                let changeText = '';
                
                if (change > 0.001) {
                    changeClass = 'increase';
                    changeIcon = '<i class="fas fa-arrow-up"></i>';
                    changeText = `+${change.toFixed(4)} (+${changePercent.toFixed(2)}%)`;
                } else if (change < -0.001) {
                    changeClass = 'decrease';
                    changeIcon = '<i class="fas fa-arrow-down"></i>';
                    changeText = `${change.toFixed(4)} (${changePercent.toFixed(2)}%)`;
                } else {
                    changeClass = 'neutral';
                    changeIcon = '<i class="fas fa-minus"></i>';
                    changeText = `0.0000 (0.00%)`;
                }
                
                html += `
                    <tr>
                        <td>${rateInfo.name}</td>
                        <td><span class="currency-code">${currencyCode}</span></td>
                        <td class="rate-value">${value.toFixed(4)}</td>
                        <td class="rate-previous">${previous.toFixed(4)}</td>
                        <td class="change ${changeClass}">
                            ${changeIcon} ${changeText}
                        </td>
                        <td>
                            <span class="status-badge ${changeClass}">
                                ${changeClass.toUpperCase()}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Добавление записи в лог
        function addLogEntry(type, message, isSystem = false, icon = null) {
            const timestamp = new Date();
            const timeStr = timestamp.toLocaleTimeString();
            
            // Определяем иконку по умолчанию
            if (!icon) {
                switch(type) {
                    case 'increase': icon = 'fas fa-arrow-up'; break;
                    case 'decrease': icon = 'fas fa-arrow-down'; break;
                    case 'new': icon = 'fas fa-plus-circle'; break;
                    case 'system': icon = 'fas fa-info-circle'; break;
                    default: icon = 'fas fa-exchange-alt';
                }
            }
            
            const logEntry = {
                id: Date.now() + Math.random(),
                time: timeStr,
                timestamp: timestamp,
                type: type,
                message: message,
                isSystem: isSystem,
                icon: icon
            };
            
            logEntries.unshift(logEntry); // Добавляем в начало
            
            // Ограничиваем количество записей в логе
            if (logEntries.length > 100) {
                logEntries.pop();
            }
            
            // Обновляем счетчик
            document.getElementById('log-count').textContent = `${logEntries.length} messages`;
            
            // Добавляем в DOM
            addLogEntryToDOM(logEntry);
        }
        
        // Добавление записи в DOM
        function addLogEntryToDOM(logEntry) {
            const logContainer = document.getElementById('log-container');
            
            const logElement = document.createElement('div');
            logElement.className = `log-entry ${logEntry.type}`;
            logElement.dataset.id = logEntry.id;
            logElement.dataset.type = logEntry.type;
            
            logElement.innerHTML = `
                <div class="log-time">${logEntry.time}</div>
                <div class="log-content">
                    <i class="${logEntry.icon}"></i>
                    <span>${logEntry.message}</span>
                </div>
            `;
            
            // Добавляем в начало контейнера
            if (logContainer.firstChild) {
                logContainer.insertBefore(logElement, logContainer.firstChild);
            } else {
                logContainer.appendChild(logElement);
            }
            
            // Удаляем сообщение "Waiting for updates..." если оно есть
            const waitingMsg = logContainer.querySelector('.log-entry.system:last-child');
            if (waitingMsg && waitingMsg.querySelector('span').textContent === 'Waiting for updates...') {
                waitingMsg.remove();
            }
        }
        
        // Отправка подписки на валюты
        function sendSubscription() {
            const selectedCurrencies = getSelectedCurrencies();
            
            const message = {
                type: 'subscribe',
                currencies: selectedCurrencies
            };
            
            sendWebSocketMessage(message);
        }
        
        // Получение выбранных валют
        function getSelectedCurrencies() {
            const checkboxes = document.querySelectorAll('.currency-checkbox input:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        // Отправка сообщения через WebSocket
        function sendWebSocketMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
                return true;
            } else {
                addLogEntry('system', 'Cannot send message: WebSocket is not connected', true);
                return false;
            }
        }
        
        // Отправка ping
        function sendPing() {
            sendWebSocketMessage({ type: 'ping' });
        }
        
        // Обновление статуса подключения
        function updateStatus(status, text) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            indicator.className = 'status-' + status;
            statusText.textContent = text;
        }
        
        // Обновление времени подключения
        function updateConnectedTime() {
            if (connectedTime) {
                const now = new Date();
                const diffMs = now - connectedTime;
                const diffSec = Math.floor(diffMs / 1000);
                
                const hours = Math.floor(diffSec / 3600);
                const minutes = Math.floor((diffSec % 3600) / 60);
                const seconds = diffSec % 60;
                
                let timeStr = '';
                if (hours > 0) {
                    timeStr = `${hours}h ${minutes}m ${seconds}s`;
                } else if (minutes > 0) {
                    timeStr = `${minutes}m ${seconds}s`;
                } else {
                    timeStr = `${seconds}s`;
                }
                
                document.getElementById('connected-time').textContent = timeStr;
            }
        }
        
        // Обновление времени последнего обновления
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            document.getElementById('last-update').textContent = `Last update: ${timeStr}`;
        }
        
        // Настройка обработчиков событий
        function setupEventListeners() {
            // Кнопка подписки на все валюты
            document.getElementById('subscribe-all').addEventListener('click', function() {
                // Отмечаем все чекбоксы
                document.querySelectorAll('.currency-checkbox input').forEach(cb => {
                    cb.checked = true;
                });
                
                // Отправляем подписку
                sendSubscription();
            });
            
            // Кнопка подписки на выбранные валюты
            document.getElementById('subscribe-selected').addEventListener('click', function() {
                sendSubscription();
            });
            
            // Кнопка получения текущих курсов
            document.getElementById('get-rates').addEventListener('click', function() {
                sendWebSocketMessage({ type: 'get_rates' });
            });
            
            // Кнопка имитации изменений (только в тестовом режиме)
            const simulateBtn = document.getElementById('simulate-change');
            if (simulateBtn) {
                simulateBtn.addEventListener('click', function() {
                    sendWebSocketMessage({ type: 'simulate_change' });
                });
            }
            
            // Кнопка очистки лога
            document.getElementById('clear-log').addEventListener('click', function() {
                logEntries = [];
                document.getElementById('log-container').innerHTML = '';
                document.getElementById('log-count').textContent = '0 messages';
                addLogEntry('system', 'Log cleared', true);
            });
            
            // Фильтры лога
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Убираем активный класс со всех кнопок
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    // Добавляем активный класс на текущую кнопку
                    this.classList.add('active');
                    
                    // Применяем фильтр
                    const filter = this.dataset.filter;
                    applyLogFilter(filter);
                });
            });
            
            // Изменение выбора валют
            document.querySelectorAll('.currency-checkbox input').forEach(cb => {
                cb.addEventListener('change', function() {
                    // Автоматически отправляем подписку при изменении выбора
                    sendSubscription();
                });
            });
        }
        
        // Применение фильтра к логу
        function applyLogFilter(filterType) {
            const logEntries = document.querySelectorAll('.log-entry');
            
            logEntries.forEach(entry => {
                const entryType = entry.dataset.type;
                
                if (filterType === 'all' || 
                    (filterType === 'system' && entry.dataset.type === 'system') ||
                    (filterType === entryType && entry.dataset.type !== 'system')) {
                    entry.style.display = 'flex';
                } else {
                    entry.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>